<?xml version="1.0" encoding="UTF-8"?>

<launch>
    <set_env name="GZ_RENDER_ENGINE" value="ogre2"/>
    <set_env name="LIBGL_ALWAYS_SOFTWARE" value="1"/>
    <set_env name="MESA_LOADER_DRIVER_OVERRIDE" value="llvmpipe"/>
    <set_env name="QT_X11_NO_MITSHM" value="1"/>    
    
    <let name="urdf_path" 
         value="$(find-pkg-share sirgas_description)/urdf/pba.urdf.xacro" />
    <arg name="use_sim_time" default="true"/>    

    <include file="$(find-pkg-share ros_gz_sim)/launch/gz_sim.launch.py">
        <arg name="use_sim_time" value="$(var use_sim_time)" />
        <arg name="gz_args" value="-r empty.sdf" />
    </include>
    <timer period="3.0"/>

    <node pkg="ros_gz_bridge" exec="parameter_bridge" name="bridge_clock" output="screen"
        args="/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock"/>
    
    <node pkg="robot_state_publisher" exec="robot_state_publisher">
        <param name="use_sim_time" value="$(var use_sim_time)" />
        <param name="robot_description" value="$(command 'xacro $(var urdf_path)')" />
    </node>
    <node pkg="ros_gz_sim" exec="create"
          args="-topic robot_description -name peg_board_assembly -z 0.0"
          output="screen" />
    <timer period="5.0"/>

    <let name="controller_config_path" 
         value="$(find-pkg-share sirgas_description)/config/pba_controller.yaml" />
    <!-- <node pkg="controller_manager" exec="ros2_control_node" 
          output="screen" respawn="true">
        <param from="$(var controller_config_path)" />
        <param name="use_sim_time" value="$(var use_sim_time)" />
        <param name="robot_description" value="$(command 'xacro $(var urdf_path)')" />
    </node> -->
    <timer period="8.0"/>
    <node pkg="controller_manager" exec="spawner" args="joint_state_broadcaster"
          output="screen" />
    <timer period="10.0"/>
    <node pkg="controller_manager" exec="spawner" args="forward_velocity_controller"
          output="screen" />

      <node pkg="ros_gz_sim" exec="create" name="spawn_sim_cam" output="screen"
            args="-file $(find-pkg-share sirgas_description)/meshes/sim_cam/model.sdf -name sim_cam -x 0 -y 0 -z 2 -R 0 1.57 0"/>

      <timer period="2.0"/> 
      <node pkg="ros_gz_bridge" exec="parameter_bridge" name="bridge_sim_cam" output="screen"
            args="/camera_feed/image@sensor_msgs/msg/Image@gz.msgs.Image
                  /camera_feed/camera_info@sensor_msgs/msg/CameraInfo@gz.msgs.CameraInfo"/>

</launch>