<?xml version="1.0" encoding="UTF-8"?>

<launch>
    <set_env name="GZ_RENDER_ENGINE" value="ogre2"/>
    <set_env name="LIBGL_ALWAYS_SOFTWARE" value="1"/>
    <set_env name="MESA_LOADER_DRIVER_OVERRIDE" value="llvmpipe"/>
    <set_env name="QT_X11_NO_MITSHM" value="1"/>    
    <!-- Load robot description -->
    <let name="urdf_path" 
         value="$(find-pkg-share sirgas_description)/urdf/pba.urdf.xacro" />
    
    <arg name="use_sim_time" default="true"/>    
    <!-- Launch Ignition Gazebo -->

    <include file="$(find-pkg-share ros_gz_sim)/launch/gz_sim.launch.py">
        <arg name="use_sim_time" value="$(var use_sim_time)" />
        <arg name="gz_args" value="-r empty.sdf" />
    </include>

    <!-- Wait for Gazebo to start -->
    <timer period="3.0"/>

  <!-- Bridge the simulation clock into ROS 2 -->
  <node pkg="ros_gz_bridge" exec="parameter_bridge" name="bridge_clock" output="screen"
        args="/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock"/>
    <!-- Load robot description -->
    <node pkg="robot_state_publisher" exec="robot_state_publisher">
        <param name="use_sim_time" value="$(var use_sim_time)" />
        <param name="robot_description" value="$(command 'xacro $(var urdf_path)')" />
    </node>

    <!-- Spawn robot in Gazebo -->
    <node pkg="ros_gz_sim" exec="create"
          args="-topic robot_description -name peg_board_assembly -z 0.0"
          output="screen" />

    <!-- Wait for robot to spawn -->
    <timer period="5.0"/>

    <!-- Load controller configuration -->
    <let name="controller_config_path" 
         value="$(find-pkg-share sirgas_description)/config/pba_controller.yaml" />

    <!-- Load controllers -->
    <node pkg="controller_manager" exec="ros2_control_node" 
          output="screen" respawn="true">
        <param from="$(var controller_config_path)" />
        <param name="use_sim_time" value="$(var use_sim_time)" />
        <param name="robot_description" value="$(command 'xacro $(var urdf_path)')" />
    </node>

    <!-- Wait for controller manager to start -->
    <timer period="8.0"/>

    <!-- Spawn joint state broadcaster -->
    <node pkg="controller_manager" exec="spawner" args="joint_state_broadcaster"
          output="screen" />

    <!-- Wait for joint state broadcaster -->
    <timer period="10.0"/>

    <!-- Spawn velocity controller -->
    <node pkg="controller_manager" exec="spawner" args="forward_velocity_controller"
          output="screen" />

    <!-- Spawn the static camera model (unchanged) -->
    <node pkg="ros_gz_sim" exec="create" name="spawn_sim_cam" output="screen"
    args="-file $(find-pkg-share sirgas_description)/meshes/sim_cam/model.sdf -name sim_cam -x 0 -y 0 -z 1.2"/>

    <!-- Bridges (GZ <-> ROS). Bidirectional is fine here -->
    <node pkg="ros_gz_bridge" exec="parameter_bridge" name="bridge_sim_cam" output="screen"
    args="/sim_cam/image@sensor_msgs/msg/Image@gz.msgs.Image
            /sim_cam/camera_info@sensor_msgs/msg/CameraInfo@gz.msgs.CameraInfo"/>

</launch>